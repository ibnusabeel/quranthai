---
import Layout from '../../../components/Layout.astro';
import { getCollection, getEntry } from 'astro:content';
import { SURAHS } from '../../../data/surahs';

const { book, surah: surahParam } = Astro.params;
const surahNumber = parseInt(surahParam as string);

// โหลดข้อมูลหนังสือ
const bookEntry = await getEntry('books', book as string);

// โหลดข้อมูลตัฟซีรทั้งหมดของหนังสือนี้ และกรองเฉพาะซูเราะห์ที่เลือก
const allTafsir = await getCollection('tafsir');
const surahEntries = allTafsir
  .filter(entry => 
    entry.id.startsWith(`${book}/`) && 
    entry.data.surahNumber === surahNumber
  )
  .sort((a, b) => a.data.ayahStart - b.data.ayahStart); // เรียงตามอายะฮ์

// ดึงข้อมูลซูเราะห์จาก Database
const surahInfo = SURAHS.find(s => s.number === surahNumber);

const bookInfo = bookEntry ? {
  titleThai: bookEntry.data.titleThai,
  titleArabic: bookEntry.data.titleArabic || ''
} : null;

// Render entries logic removed, now we just pass data
const entries = surahEntries.map(entry => {
  const parts = entry.id.split('/');
  const filename = parts[parts.length - 1]; // get 'part-1' from 'tafsir-sadi/004/part-1.mdoc'
  const slug = filename.replace(/\.(mdoc|mdx)$/, '');
  
  return {
    ...entry,
    linkSlug: slug
  };
});
---

<Layout title={`${surahInfo?.nameThai || 'ตัฟซีร'} - ${bookInfo?.titleThai || 'สารานุกรม'}`}>
  <div class="container"><br>
    {surahInfo && bookInfo ? (
      <>
        <nav class="breadcrumb">
          <a href="/">หน้าแรก</a>
          <span class="separator">›</span>
          <a href={`/tafsir/${book}`}>{bookInfo.titleThai}</a>
          <span class="separator">›</span>
          <span class="current">{surahInfo.nameThai}</span>
        </nav>

        <header class="surah-header">
          <div class="surah-badge">ซูเราะห์ที่ {surahInfo.number}</div>
          <h1 class="surah-title">{surahInfo.nameThai}</h1>
          <p class="surah-title-arabic text-arabic">{surahInfo.nameArabic}</p>
          <div class="surah-meta">
            <span class="badge">{surahInfo.type === 'Makkah' ? 'มักกียะฮฺ' : 'มะดะนียะฮฺ'}</span>
            <span class="badge">{surahInfo.ayahCount} อายะฮ์</span>
            <span class="badge badge-count">{entries.length} บทความ</span>
          </div>
        </header>

        <main class="entries-section">
          {entries.length > 0 ? (
            <div class="entries-grid">
              {entries.map(entry => (
                <a href={`/tafsir/${book}/${surahNumber}/${entry.linkSlug}`} class="entry-card">
                  <div class="card-body">
                    <div class="ayah-badge">อายะฮ์ {entry.data.ayahStart} - {entry.data.ayahEnd}</div>
                    <h3 class="card-title text-xl font-bold mb-2">
                      {entry.data.title || `บทอธิบายช่วงอายะฮ์ที่ ${entry.data.ayahStart}-${entry.data.ayahEnd}`}
                    </h3>
                    <p class="read-more">อ่านเนื้อหา →</p>
                  </div>
                </a>
              ))}
            </div>
          ) : (
             <div class="empty-state">
                <p>ยังไม่มีเนื้อหาตัฟซีรในซูเราะห์นี้</p>
                <a href="/keystatic" class="btn-add">เพิ่มเนื้อหา +</a>
             </div>
          )}
        </main>

        <nav class="surah-navigation">
          <a href={`/tafsir/${book}`} class="nav-button">
            ← กลับไปสารบัญซูเราะห์
          </a>
        </nav>
      </>
    ) : (
      <div class="error-message">
        <h2>ไม่พบข้อมูล</h2>
        <a href={`/tafsir/${book}`} class="btn btn-primary">กลับไปสารบัญ</a>
      </div>
    )}
  </div>
</Layout>

<style>
  /* Layout & Header */
  .container { max-width: 1000px; margin: 0 auto; padding: 0 var(--space-4); }
  .surah-header { text-align: center; margin-bottom: var(--space-8); padding: var(--space-8) 0; border-bottom: 1px solid var(--color-neutral-200); }
  .surah-title { font-size: var(--text-4xl); margin: var(--space-2) 0; color: var(--color-text-primary); }
  .surah-title-arabic { font-size: var(--text-3xl); color: var(--color-primary-600); margin-bottom: var(--space-4); }
  .surah-meta { display: flex; gap: var(--space-3); justify-content: center; }
  
  .badge { background: var(--color-neutral-100); padding: 4px 12px; border-radius: 20px; font-size: 0.9em; color: var(--color-text-secondary); border: 1px solid var(--color-neutral-200); }
  .badge-count { background: var(--color-primary-100); color: var(--color-primary-700); border-color: var(--color-primary-200); }
  .surah-badge { text-transform: uppercase; letter-spacing: 1px; font-size: 0.8em; color: var(--color-text-secondary); font-weight: bold; }

  /* Breadcrumb */
  .breadcrumb { display: flex; align-items: center; gap: var(--space-2); margin-bottom: var(--space-6); font-size: var(--text-sm); color: var(--color-text-secondary); }
  .breadcrumb a { color: var(--color-primary-600); text-decoration: none; }
  .breadcrumb a:hover { text-decoration: underline; color: var(--color-secondary-500); }
  .separator { color: var(--color-text-disabled); }
  .current { color: var(--color-text-primary); font-weight: 500; }

  /* Grid */
  .entries-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: var(--space-6); margin-bottom: var(--space-12); }
  
  /* Card */
  .entry-card { 
    display: block; 
    background: var(--color-surface); 
    border: 1px solid var(--color-neutral-200); 
    border-radius: var(--radius-lg); 
    text-decoration: none; 
    color: inherit; 
    transition: all 0.2s ease;
    box-shadow: var(--shadow-sm);
  }
  .entry-card:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-md);
    border-color: var(--color-primary-300);
    /* Subtle Navy glow in dark mode, light gold in light mode */
    background: linear-gradient(to bottom right, var(--color-surface), var(--color-primary-50));
  }
  .card-body { padding: var(--space-6); }
  
  .ayah-badge { 
    display: inline-block; 
    background: var(--color-secondary-100); 
    color: var(--color-secondary-700); 
    padding: 2px 10px; 
    border-radius: 6px; 
    font-size: 0.85em; 
    font-weight: 600; 
    margin-bottom: var(--space-3);
    border: 1px solid var(--color-secondary-200);
  }
  
  .card-title { font-size: 1.25rem; font-weight: 600; color: var(--color-text-primary); line-height: 1.4; }
  .read-more { margin-top: var(--space-4); color: var(--color-primary-600); font-size: 0.9em; font-weight: 500; }
  .entry-card:hover .read-more { color: var(--color-secondary-500); }

  /* Empty State */
  .empty-state { text-align: center; padding: var(--space-12); background: var(--color-surface-variant); border-radius: var(--radius-lg); color: var(--color-text-secondary); border: 1px dashed var(--color-neutral-300); }
  .btn-add { display: inline-block; margin-top: var(--space-4); padding: 8px 16px; background: var(--color-primary-600); color: var(--color-text-on-primary); border-radius: 6px; text-decoration: none; font-size: 0.9em; }

  /* Nav */
  .surah-navigation { border-top: 1px solid var(--color-neutral-200); padding-top: var(--space-6); text-align: center; }
  .nav-button { color: var(--color-text-secondary); text-decoration: none; font-weight: 500; transition: color 0.2s; }
  .nav-button:hover { color: var(--color-primary-600); }
  
  .error-message { text-align: center; padding: var(--space-10); }
  .btn-primary { display: inline-block; padding: 10px 20px; background: var(--color-primary-600); color: var(--color-text-on-primary); border-radius: 6px; margin-top: var(--space-4); text-decoration: none; }
</style>
