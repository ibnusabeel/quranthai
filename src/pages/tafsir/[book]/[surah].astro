---
import Layout from "../../../components/Layout.astro";
import { getEntry } from "astro:content";
import { createReader } from "@keystatic/core/reader";
import keystaticConfig from "../../../../keystatic.config";

export const prerender = false;

const { book, surah: surahParam } = Astro.params;
const surahNumber = parseInt(surahParam as string);
const surahSlug = String(surahNumber).padStart(3, "0");

// Fetch from Astro Content Collection (Cloudflare compatible)
// Use 'as any' for collection name since it comes from dynamic param
const entry = await getEntry(book as any, surahSlug);

if (!entry) {
  return Astro.redirect("/404");
}

const { nameThai, nameArabic, ayahs } = entry.data;

// Helper to determine if description exists and is not empty
const hasDescription = (desc: any) => {
  return typeof desc === "string" && desc.trim().length > 0;
};

// Load Book Info (using Astro getEntry for simple fields)
const bookEntry = await getEntry("books", book as string);
const bookInfo = bookEntry
  ? {
      titleThai: bookEntry.data.titleThai,
      titleArabic: bookEntry.data.titleArabic || "",
    }
  : null;
---

<Layout
  title={`${nameThai || "‡∏ï‡∏±‡∏ü‡∏ã‡∏µ‡∏£"} - ${bookInfo?.titleThai || "‡∏™‡∏≤‡∏£‡∏≤‡∏ô‡∏∏‡∏Å‡∏£‡∏°"}`}
>
  <!-- Hero Section -->
  <section class="surah-hero">
    <div class="hero-bg-pattern"></div>
    <div class="container">
      <a href={`/tafsir/${book}`} class="back-link">
        <svg
          width="20"
          height="20"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
        >
          <path d="M19 12H5M12 19l-7-7 7-7"></path>
        </svg>
        <span>‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏≤‡∏£‡∏ö‡∏±‡∏ç</span>
      </a>

      <div class="hero-content">
        <div class="surah-badge">
          <span class="badge-icon">üìñ</span>
          <span>‡∏ã‡∏π‡πÄ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ó‡∏µ‡πà {surahNumber}</span>
        </div>

        <h1 class="surah-title">{nameThai}</h1>
        <p class="surah-title-arabic text-arabic font-amiri">{nameArabic}</p>

        <div class="surah-stats">
          <div class="stat-item">
            <div class="stat-icon">üî¢</div>
            <div class="stat-value">{ayahs?.length || 0}</div>
            <div class="stat-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏≠‡∏≤‡∏¢‡∏∞‡∏Æ‡πå</div>
          </div>
          <div class="stat-item">
            <div class="stat-icon">üìö</div>
            <div class="stat-value">{bookInfo?.titleThai || "‡∏ï‡∏±‡∏ü‡∏ã‡∏µ‡∏£"}</div>
            <div class="stat-label">‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏à‡∏≤‡∏Å</div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Search/Filter Section -->
  <div class="container mb-8 sticky top-4 z-10">
    <div class="search-wrapper">
      <span class="search-icon">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="20"
          height="20"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
          ><circle cx="11" cy="11" r="8"></circle><line
            x1="21"
            y1="21"
            x2="16.65"
            y2="16.65"></line></svg
        >
      </span>
      <input
        type="text"
        id="ayah-search"
        placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏≠‡∏≤‡∏¢‡∏∞‡∏Æ‡πå... (‡∏û‡∏¥‡∏°‡∏û‡πå‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç ‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°)"
        class="search-input"
        autocomplete="off"
      />
      <div id="search-stats" class="search-stats hidden">
        ‡πÄ‡∏à‡∏≠ <span id="match-count">0</span> ‡∏≠‡∏≤‡∏¢‡∏∞‡∏Æ‡πå
      </div>
    </div>
  </div>

  <!-- Ayahs Section -->
  <section class="ayahs-section">
    <div class="container">
      {
        ayahs && ayahs.length > 0 ? (
          <div class="ayahs-list">
            {ayahs.map((ayah) => (
              <>
                <div class="ayah-card" id={`ayah-${ayah.ayahNumber}`}>
                  <div class="ayah-header">
                    <span class="ayah-badge">{ayah.ayahNumber}</span>
                    <div class="ayah-actions">
                      {ayah.audio && (
                        <button
                          class="btn-audio"
                          data-audio={ayah.audio}
                          aria-label="Play Audio"
                        >
                          <span class="icon-play">
                            <svg
                              xmlns="http://www.w3.org/2000/svg"
                              width="24"
                              height="24"
                              viewBox="0 0 24 24"
                              fill="currentColor"
                            >
                              <path d="M8 5v14l11-7z" />
                            </svg>
                          </span>
                          <span class="icon-pause">
                            <svg
                              xmlns="http://www.w3.org/2000/svg"
                              width="24"
                              height="24"
                              viewBox="0 0 24 24"
                              fill="currentColor"
                            >
                              <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z" />
                            </svg>
                          </span>
                        </button>
                      )}
                    </div>
                  </div>

                  <div class="ayah-content">
                    <p class="arabic-text font-amiri" dir="rtl">
                      {ayah.arabic}
                    </p>
                    <div class="thai-translation">
                      <p class="thai-text">{ayah.thai}</p>
                    </div>
                  </div>
                </div>

                {/* Tafsir/Description Section - Separated Card */}
                {hasDescription(ayah.description) && (
                  <div class="tafsir-card">
                    <div class="tafsir-header">
                      <span class="tafsir-icon">üìñ</span>
                      <span class="font-bold text-secondary-800">
                        ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢ (‡∏ï‡∏±‡∏ü‡∏ã‡∏µ‡∏£) ‡∏≠‡∏≤‡∏¢‡∏∞‡∏Æ‡∏∫‡∏ó‡∏µ‡πà {ayah.tafsirRange}
                      </span>
                    </div>
                    <div class="tafsir-content-wrapper">
                      <div class="prose prose-sm max-w-none dark:prose-invert">
                        <p class="whitespace-pre-wrap">{ayah.description}</p>
                      </div>
                    </div>
                  </div>
                )}
              </>
            ))}
          </div>
        ) : (
          <div class="empty-state">
            <p>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≤‡∏¢‡∏∞‡∏Æ‡πå</p>
          </div>
        )
      }
    </div>
  </section>

  {/* Hidden Audio Player */}
  <audio id="global-player" style="display: none;"></audio>
</Layout>

<script>
  // Advanced Audio Player Logic
  const player = document.getElementById("global-player") as HTMLAudioElement;
  const buttons = document.querySelectorAll(".btn-audio");

  // --- Start Search Logic ---
  const searchInput = document.getElementById(
    "ayah-search",
  ) as HTMLInputElement;
  const searchStats = document.getElementById("search-stats");
  const matchCountSpan = document.getElementById("match-count");

  // Cache original content for highlighting
  const ayahCards = document.querySelectorAll(".ayah-card");
  const cardData = new Map();

  ayahCards.forEach((card) => {
    const arabicEl = card.querySelector(".arabic-text");
    const thaiEl = card.querySelector(".thai-text");
    const ayahBadge = card.querySelector(".ayah-badge");

    cardData.set(card, {
      arabicEl,
      thaiEl,
      ayahBadge,
      originalArabic: arabicEl?.textContent || "",
      originalThai: thaiEl?.textContent || "",
      ayahNum: ayahBadge?.textContent || "",
    });
  });

  if (searchInput) {
    searchInput.addEventListener("input", (e) => {
      const term = (e.target as HTMLInputElement).value.toLowerCase().trim();
      let matchCount = 0;

      // Helper to highlight text safely
      const highlightText = (text: string, searchTerm: string) => {
        if (!searchTerm) return text;
        const regex = new RegExp(
          `(${searchTerm.replace(/[.*+?^${}()|[\]\\]/g, "\\$&")})`,
          "gi",
        );
        return text.replace(regex, '<mark class="highlight">$1</mark>');
      };

      ayahCards.forEach((card) => {
        const data = cardData.get(card);
        const cardEl = card as HTMLElement;

        // Logic: Match Number, Arabic, or Thai
        const isMatch =
          data.ayahNum.includes(term) ||
          data.originalArabic.toLowerCase().includes(term) ||
          data.originalThai.toLowerCase().includes(term);

        // Handle associated Tafsir Card (next sibling)
        const nextEl = cardEl.nextElementSibling as HTMLElement;
        const hasTafsir = nextEl && nextEl.classList.contains("tafsir-card");

        if (term === "" || isMatch) {
          cardEl.style.display = "";
          if (hasTafsir) nextEl.style.display = "";
          matchCount++;

          // Apply Highlight
          if (term !== "") {
            if (data.arabicEl)
              data.arabicEl.innerHTML = highlightText(
                data.originalArabic,
                term,
              );
            if (data.thaiEl)
              data.thaiEl.innerHTML = highlightText(data.originalThai, term);
          } else {
            // Reset
            if (data.arabicEl) data.arabicEl.textContent = data.originalArabic;
            if (data.thaiEl) data.thaiEl.textContent = data.originalThai;
          }
        } else {
          cardEl.style.display = "none";
          if (hasTafsir) nextEl.style.display = "none";
        }
      });

      if (searchStats && matchCountSpan) {
        matchCountSpan.textContent = matchCount.toString();
        if (term) {
          searchStats.classList.remove("hidden");
        } else {
          searchStats.classList.add("hidden");
        }
      }
    });
  }
  // --- End Search Logic ---

  function resetAllButtons() {
    buttons.forEach((btn) => btn.classList.remove("playing"));
  }

  function updateButtonState(url: string | null, isPlaying: boolean) {
    if (!url) return;
    const btn = document.querySelector(`.btn-audio[data-audio="${url}"]`);
    if (btn) {
      if (isPlaying) {
        btn.classList.add("playing");
      } else {
        btn.classList.remove("playing");
      }
    }
  }

  // Player Events
  player.addEventListener("play", () => {
    const currentUrl = player.getAttribute("src"); // src prop might be resolved, use stored if needed but direct src usually works
    // Or better, find via src
    // Note: player.src is absolute URL.
    // It's safer to track current playing URL manually or match flexibly.
    // Let's rely on the button click logic to set active state initially, but 'play' event confirms it.
    // Actually, iterate buttons to match src
    buttons.forEach((btn) => {
      if (player.src.endsWith(btn.getAttribute("data-audio") || "")) {
        btn.classList.add("playing");
      } else {
        btn.classList.remove("playing");
      }
    });
  });

  player.addEventListener("pause", () => {
    resetAllButtons();
  });

  player.addEventListener("ended", () => {
    resetAllButtons();
  });

  // Button Interaction
  buttons.forEach((btn) => {
    btn.addEventListener("click", () => {
      const url = btn.getAttribute("data-audio");
      if (!url) return;

      // If clicking same button that is playing
      if (player.src.includes(url) && !player.paused) {
        player.pause();
      } else {
        // Play new
        resetAllButtons();
        player.src = url;
        player.play();
        btn.classList.add("playing"); // Optimistic UI
      }
    });
  });
</script>

<style>
  /* ==================== HERO SECTION (Matched to Book Page) ==================== */
  .surah-hero {
    background: linear-gradient(
      135deg,
      hsl(215, 90%, 25%) 0%,
      hsl(215, 85%, 20%) 50%,
      hsl(215, 90%, 15%) 100%
    );
    color: white;
    padding: var(--space-16) 0 var(--space-12);
    position: relative;
    overflow: hidden;
    margin-bottom: var(--space-12);
  }

  .hero-bg-pattern {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    opacity: 0.1;
    background-image:
      radial-gradient(
        circle at 20% 30%,
        var(--color-secondary-500) 0%,
        transparent 50%
      ),
      radial-gradient(
        circle at 80% 70%,
        var(--color-primary-400) 0%,
        transparent 50%
      );
    pointer-events: none;
  }

  .hero-content {
    position: relative;
    z-index: 1;
    text-align: center;
    max-width: 900px;
    margin: 0 auto;
    animation: fadeInUp 0.6s ease-out;
  }

  .back-link {
    display: inline-flex;
    align-items: center;
    gap: var(--space-2);
    color: rgba(255, 255, 255, 0.8);
    font-weight: var(--font-medium);
    margin-bottom: var(--space-8);
    text-decoration: none;
    transition: all 0.2s ease;
    font-size: 0.9rem;
  }

  .back-link:hover {
    color: var(--color-secondary-400);
    transform: translateX(-4px);
  }

  .surah-badge {
    display: inline-flex;
    align-items: center;
    gap: var(--space-2);
    background: rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 9999px;
    padding: var(--space-2) var(--space-5);
    font-size: 0.9rem;
    font-weight: 500;
    margin-bottom: var(--space-6);
  }

  .surah-title {
    font-size: 3rem; /* Adjusted for Surah specifics */
    font-weight: bold;
    line-height: 1.2;
    margin-bottom: var(--space-4);
    color: white;
  }

  .surah-title-arabic {
    font-size: 2.5rem;
    color: var(--color-secondary-400);
    margin-bottom: var(--space-8);
    opacity: 0.95;
    line-height: 1.4;
  }

  .surah-stats {
    display: flex;
    gap: var(--space-8);
    justify-content: center;
    margin-top: var(--space-8);
  }

  .stat-item {
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.15);
    border-radius: var(--radius-xl);
    padding: var(--space-4) var(--space-6);
    min-width: 120px;
    transition: all 0.2s ease;
  }

  .stat-item:hover {
    background: rgba(255, 255, 255, 0.15);
    transform: translateY(-4px);
    border-color: var(--color-secondary-400);
  }

  .stat-icon {
    font-size: 1.5rem;
    margin-bottom: var(--space-2);
  }

  .stat-value {
    font-size: 2rem;
    font-weight: bold;
    color: var(--color-secondary-400);
    line-height: 1;
    margin-bottom: var(--space-1);
  }

  .stat-label {
    font-size: 0.85rem;
    opacity: 0.9;
    font-weight: 500;
  }

  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(30px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Responsive Adjustments matched from index.astro */
  @media (max-width: 768px) {
    .surah-hero {
      padding: var(--space-12) 0 var(--space-8);
    }
    .surah-title {
      font-size: 2rem;
    }
    .surah-title-arabic {
      font-size: 1.8rem;
    }
    .surah-stats {
      gap: var(--space-4);
    }
    .stat-item {
      min-width: 100px;
      padding: var(--space-4);
    }
    .stat-value {
      font-size: 1.5rem;
    }
  }

  /* Dark Mode specific overrides */
  :global([data-theme="dark"]) .surah-hero {
    background: linear-gradient(
      135deg,
      hsl(218, 35%, 15%) 0%,
      hsl(218, 40%, 10%) 50%,
      hsl(218, 45%, 8%) 100%
    );
  }

  .font-amiri {
    font-family: "Amiri", "Notfl", serif;
  }

  .ayahs-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-6);
  }

  .ayah-card {
    background: var(--color-surface);
    border: 1px solid var(--color-neutral-200);
    border-radius: var(--radius-xl);
    padding: var(--space-6) var(--space-8);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
    transition:
      transform 0.2s ease,
      box-shadow 0.2s ease;
  }

  .ayah-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.06);
    border-color: var(--color-primary-200);
  }

  .ayah-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: var(--space-4);
  }

  .ayah-badge {
    display: inline-flex;
    width: 36px;
    height: 36px;
    align-items: center;
    justify-content: center;
    background: var(--color-primary-50);
    color: var(--color-primary-700);
    border: 1px solid var(--color-primary-100);
    border-radius: 50%;
    font-weight: 700;
    font-size: 0.95rem;
    font-feature-settings: "tnum";
  }

  /* Audio Button Styles */
  .btn-audio {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    border: 1px solid var(--color-neutral-200);
    background: white;
    color: var(--color-neutral-600);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .btn-audio:hover {
    background: var(--color-primary-50);
    color: var(--color-primary-600);
    border-color: var(--color-primary-200);
    transform: scale(1.05);
  }

  .btn-audio.playing {
    background: var(--color-primary-600);
    color: white;
    border-color: var(--color-primary-700);
    box-shadow: 0 0 0 3px var(--color-primary-100);
  }

  .btn-audio .icon-pause {
    display: none;
  }
  .btn-audio.playing .icon-play {
    display: none;
  }
  .btn-audio.playing .icon-pause {
    display: block;
  }

  .ayah-content {
    display: flex;
    flex-direction: column;
    gap: var(--space-6);
  }

  .arabic-text {
    font-size: 2.6rem;
    line-height: 2.2;
    text-align: right;
    color: #000;
    margin-bottom: var(--space-2);
    font-weight: 500;
  }

  /* Distinct Thai Translation */
  .thai-translation {
    background: linear-gradient(to right, var(--color-neutral-50), transparent);
    border-left: 3px solid var(--color-primary-400);
    padding: var(--space-4) var(--space-5);
    border-radius: 0 var(--radius-lg) var(--radius-lg) 0;
  }

  .thai-text {
    font-size: 1.15rem;
    line-height: 1.8;
    color: var(--color-text-secondary);
    font-family: var(--font-sans); /* Use sans for better readability */
  }

  /* Tafsir Section - Separated Card */
  .tafsir-card {
    margin-top: calc(var(--space-2) * -1); /* Pull closer to ayah card above */
    margin-bottom: var(--space-6);
    background: var(--color-secondary-50);
    border: 1px solid var(--color-secondary-100);
    border-radius: 0 0 var(--radius-xl) var(--radius-xl); /* Rounded bottom only to attach visually? Or full card? */
    /* Let's make it a full separate card but connected visually via proximity */
    border-radius: var(--radius-xl);
    margin-top: var(--space-2);
    position: relative;
    overflow: hidden;
  }

  /* Or better, make it look like a comment thread below */
  .tafsir-card {
    margin-top: var(--space-4);
    background: #fdfdfd;
    border-left: 4px solid var(--color-secondary-400);
    border-radius: var(--radius-lg);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02);
  }

  .tafsir-header {
    background: var(--color-secondary-50);
    padding: var(--space-3) var(--space-5);
    border-bottom: 1px solid var(--color-secondary-100);
    display: flex;
    align-items: center;
    gap: var(--space-2);
    font-size: 0.95rem;
  }

  .tafsir-content-wrapper {
    padding: var(--space-5) var(--space-6);
  }

  /* Dark Mode Adjustments */
  :global([data-theme="dark"]) .tafsir-card {
    background: rgba(255, 255, 255, 0.02);
    border-left-color: var(--color-secondary-600);
  }

  :global([data-theme="dark"]) .tafsir-header {
    background: rgba(255, 255, 255, 0.05);
    border-bottom-color: rgba(255, 255, 255, 0.1);
  }

  :global([data-theme="dark"]) .ayah-card {
    background: var(--color-surface);
    border-color: var(--color-neutral-800);
  }

  :global([data-theme="dark"]) .arabic-text {
    color: #e0e0e0;
  }

  :global([data-theme="dark"]) .thai-translation {
    background: linear-gradient(
      to right,
      rgba(255, 255, 255, 0.03),
      transparent
    );
    border-left-color: var(--color-primary-600);
  }

  :global([data-theme="dark"]) .btn-audio {
    background: var(--color-neutral-800);
    border-color: var(--color-neutral-700);
    color: var(--color-neutral-400);
  }

  :global([data-theme="dark"]) .btn-audio:hover {
    background: var(--color-neutral-700);
    color: var(--color-primary-400);
  }

  :global([data-theme="dark"]) .btn-audio.playing {
    background: var(--color-primary-600);
    color: white;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .container {
      padding: 0 var(--space-4);
    }
    .ayah-card {
      padding: var(--space-5);
    }
    .arabic-text {
      font-size: 1.8rem;
      line-height: 1.9;
    }
    .thai-text {
      font-size: 1.05rem;
    }
    .btn-audio {
      width: 38px;
      height: 38px;
    }
  }

  /* Search Bar Styles */
  .search-wrapper {
    position: relative;
    max-width: 600px;
    margin: 0 auto;
    background: white;
    border-radius: 9999px;
    box-shadow:
      0 4px 6px -1px rgba(0, 0, 0, 0.1),
      0 2px 4px -1px rgba(0, 0, 0, 0.06);
    display: flex;
    align-items: center;
    padding: 0.5rem 1.25rem;
    border: 1px solid var(--color-neutral-200);
    transition: all 0.2s ease;
  }

  .search-wrapper:focus-within {
    border-color: var(--color-primary-400);
    transform: translateY(-2px);
    box-shadow:
      0 10px 15px -3px rgba(0, 0, 0, 0.1),
      0 4px 6px -2px rgba(0, 0, 0, 0.05);
  }

  .search-icon {
    color: var(--color-neutral-400);
    margin-right: 0.75rem;
    display: flex;
  }

  .search-input {
    flex: 1;
    border: none;
    outline: none;
    font-size: 1rem;
    color: var(--color-text-primary);
    background: transparent;
    padding: 0.25rem 0;
  }

  .search-stats {
    font-size: 0.85rem;
    color: var(--color-primary-600);
    background: var(--color-primary-50);
    padding: 2px 10px;
    border-radius: 9999px;
    white-space: nowrap;
    margin-left: 0.5rem;
    font-weight: 500;
  }

  .search-stats.hidden {
    display: none;
  }

  /* Dark Mode Search */
  :global([data-theme="dark"]) .search-wrapper {
    background: var(--color-surface);
    border-color: var(--color-neutral-700);
  }

  :global([data-theme="dark"]) .search-input {
    color: white;
  }

  :global([data-theme="dark"]) .search-stats {
    background: rgba(255, 255, 255, 0.1);
    color: var(--color-neutral-300);
  }
</style>
