---
import Layout from '../../../components/Layout.astro';
import { getCollection, getEntry } from 'astro:content';
import { SURAHS } from '../../../data/surahs';

const { book, surah: surahParam } = Astro.params;
const surahNumber = parseInt(surahParam as string);

// ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠
const bookEntry = await getEntry('books', book as string);

// ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ü‡∏ã‡∏µ‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏ô‡∏µ‡πâ ‡πÅ‡∏•‡∏∞‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ã‡∏π‡πÄ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
const allTafsir = await getCollection('tafsir');
const surahEntries = allTafsir
  .filter(entry => 
    entry.id.startsWith(`${book}/`) && 
    entry.data.surahNumber === surahNumber
  )
  .sort((a, b) => a.data.ayahStart - b.data.ayahStart); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏≠‡∏≤‡∏¢‡∏∞‡∏Æ‡πå

// ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ã‡∏π‡πÄ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏à‡∏≤‡∏Å Database
const surahInfo = SURAHS.find(s => s.number === surahNumber);

const bookInfo = bookEntry ? {
  titleThai: bookEntry.data.titleThai,
  titleArabic: bookEntry.data.titleArabic || ''
} : null;

// Render entries logic removed, now we just pass data
const entries = surahEntries.map(entry => {
  const parts = entry.id.split('/');
  const filename = parts[parts.length - 1]; // get 'part-1' from 'tafsir-sadi/004/part-1.mdoc'
  const slug = filename.replace(/\.(mdoc|mdx)$/, '');
  
  return {
    ...entry,
    linkSlug: slug
  };
});
---

<Layout title={`${surahInfo?.nameThai || '‡∏ï‡∏±‡∏ü‡∏ã‡∏µ‡∏£'} - ${bookInfo?.titleThai || '‡∏™‡∏≤‡∏£‡∏≤‡∏ô‡∏∏‡∏Å‡∏£‡∏°'}`}>
  {surahInfo && bookInfo ? (
    <>
      <!-- Hero Section -->
      <section class="surah-hero">
        <div class="hero-bg-pattern"></div>
        <div class="container">
          <nav class="breadcrumb">
            <a href="/">‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</a>
            <span class="separator">‚Ä∫</span>
            <a href={`/tafsir/${book}`}>{bookInfo.titleThai}</a>
            <span class="separator">‚Ä∫</span>
            <span class="current">{surahInfo.nameThai}</span>
          </nav>

          <div class="hero-content">
            <div class="surah-badge">‡∏ã‡∏π‡πÄ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ó‡∏µ‡πà {surahInfo.number}</div>
            <h1 class="surah-title">{surahInfo.nameThai}</h1>
            <p class="surah-title-arabic text-arabic">{surahInfo.nameArabic}</p>
            
            <div class="surah-meta">
              <span class={`badge ${surahInfo.type === 'Makkah' ? 'badge-makkah' : 'badge-madinah'}`}>
                {surahInfo.type === 'Makkah' ? '‡∏°‡∏±‡∏Å‡∏Å‡∏µ‡∏¢‡∏∞‡∏Æ‡∏∫' : '‡∏°‡∏∞‡∏î‡∏∞‡∏ô‡∏µ‡∏¢‡∏∞‡∏Æ‡∏∫'}
              </span>
              <span class="badge badge-ayah">{surahInfo.ayahCount} ‡∏≠‡∏≤‡∏¢‡∏∞‡∏Æ‡πå</span>
              <span class="badge badge-articles">{entries.length} ‡∏ö‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°</span>
            </div>
          </div>
        </div>
      </section>

      <!-- Entries Section -->
      <section class="entries-section">
        <div class="container">
          {entries.length > 0 ? (
            <div class="entries-grid">
              {entries.map(entry => (
                <a href={`/tafsir/${book}/${surahNumber}/${entry.linkSlug}`} class="entry-card">
                  <div class="card-header">
                    <div class="ayah-badge">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 20h9M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path>
                      </svg>
                      ‡∏≠‡∏≤‡∏¢‡∏∞‡∏Æ‡πå {entry.data.ayahStart} - {entry.data.ayahEnd}
                    </div>
                  </div>
                  <div class="card-body">
                    <h3 class="card-title">
                      {entry.data.title || `‡∏ö‡∏ó‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏ä‡πà‡∏ß‡∏á‡∏≠‡∏≤‡∏¢‡∏∞‡∏Æ‡πå‡∏ó‡∏µ‡πà ${entry.data.ayahStart}-${entry.data.ayahEnd}`}
                    </h3>
                    <div class="read-more">
                      <span>‡∏≠‡πà‡∏≤‡∏ô‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤</span>
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M5 12h14M12 5l7 7-7 7"></path>
                      </svg>
                    </div>
                  </div>
                </a>
              ))}
            </div>
          ) : (
             <div class="empty-state">
               <div class="empty-icon">üìñ</div>
               <h3>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ï‡∏±‡∏ü‡∏ã‡∏µ‡∏£‡πÉ‡∏ô‡∏ã‡∏π‡πÄ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ô‡∏µ‡πâ</h3>
               <p>‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ï‡∏±‡∏ü‡∏ã‡∏µ‡∏£‡πÉ‡∏´‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô CMS</p>
               <a href="/keystatic" class="btn-add">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ +</a>
             </div>
          )}

          <nav class="surah-navigation">
            <a href={`/tafsir/${book}`} class="nav-button">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M19 12H5M12 19l-7-7 7-7"></path>
              </svg>
              <span>‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏™‡∏≤‡∏£‡∏ö‡∏±‡∏ç‡∏ã‡∏π‡πÄ‡∏£‡∏≤‡∏∞‡∏´‡πå</span>
            </a>
          </nav>
        </div>
      </section>
    </>
  ) : (
    <div class="error-container">
      <div class="error-message">
        <h2>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h2>
        <p>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ã‡∏π‡πÄ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£</p>
        <a href={`/tafsir/${book}`} class="btn-primary">‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏™‡∏≤‡∏£‡∏ö‡∏±‡∏ç</a>
      </div>
    </div>
  )}
</Layout>

<style>
  /* ==================== HERO SECTION ==================== */
  .surah-hero {
    background: linear-gradient(
      135deg,
      hsl(215, 90%, 25%) 0%,
      hsl(215, 85%, 20%) 50%,
      hsl(215, 90%, 15%) 100%
    );
    color: white;
    padding: var(--space-12) 0 var(--space-10);
    position: relative;
    overflow: hidden;
    margin-bottom: var(--space-12);
  }

  .hero-bg-pattern {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    opacity: 0.1;
    background-image:
      radial-gradient(circle at 20% 30%, var(--color-secondary-500) 0%, transparent 50%),
      radial-gradient(circle at 80% 70%, var(--color-primary-400) 0%, transparent 50%);
    pointer-events: none;
  }

  .container {
    max-width: var(--container-xl);
    margin: 0 auto;
    padding: 0 var(--space-6);
  }

  .hero-content {
    position: relative;
    z-index: 1;
    text-align: center;
    max-width: 800px;
    margin: 0 auto;
    animation: fadeInUp 0.6s ease-out;
  }

  /* Breadcrumb */
  .breadcrumb {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    margin-bottom: var(--space-8);
    font-size: var(--text-sm);
    flex-wrap: wrap;
    position: relative;
    z-index: 1;
  }

  .breadcrumb a {
    color: rgba(255, 255, 255, 0.8);
    text-decoration: none;
    transition: color var(--transition-base);
  }

  .breadcrumb a:hover {
    color: var(--color-secondary-400);
  }

  .separator {
    color: rgba(255, 255, 255, 0.5);
  }

  .current {
    color: white;
    font-weight: var(--font-medium);
  }

  .surah-badge {
    display: inline-block;
    background: rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: var(--radius-full);
    padding: var(--space-2) var(--space-5);
    font-size: var(--text-sm);
    font-weight: var(--font-semibold);
    margin-bottom: var(--space-4);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .surah-title {
    font-size: var(--text-4xl);
    font-weight: var(--font-bold);
    line-height: var(--leading-tight);
    margin-bottom: var(--space-3);
  }

  .surah-title-arabic {
    font-size: var(--text-3xl);
    color: var(--color-secondary-400);
    margin-bottom: var(--space-6);
    line-height: var(--leading-relaxed);
  }

  .surah-meta {
    display: flex;
    gap: var(--space-3);
    justify-content: center;
    flex-wrap: wrap;
  }

  .badge {
    background: rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    padding: var(--space-2) var(--space-4);
    border-radius: var(--radius-full);
    font-size: var(--text-sm);
    font-weight: var(--font-medium);
  }

  .badge-makkah {
    background: rgba(255, 140, 0, 0.2);
    border-color: rgba(255, 140, 0, 0.4);
    color: #ffcc99;
  }

  .badge-madinah {
    background: rgba(50, 205, 50, 0.2);
    border-color: rgba(50, 205, 50, 0.4);
    color: #90ee90;
  }

  .badge-ayah {
    background: rgba(218, 165, 32, 0.2);
    border-color: var(--color-secondary-400);
    color: var(--color-secondary-300);
  }

  .badge-articles {
    background: rgba(100, 150, 255, 0.2);
    border-color: var(--color-primary-400);
    color: var(--color-primary-300);
  }

  /* ==================== ENTRIES SECTION ==================== */
  .entries-section {
    padding: 0 0 var(--space-16);
  }

  .entries-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: var(--space-6);
    margin-bottom: var(--space-12);
  }

  .entry-card {
    display: block;
    background: var(--color-surface);
    border: 1px solid var(--color-neutral-200);
    border-radius: var(--radius-xl);
    text-decoration: none;
    color: inherit;
    transition: all var(--transition-base);
    box-shadow: var(--shadow-sm);
    overflow: hidden;
  }

  .entry-card:hover {
    transform: translateY(-6px);
    box-shadow: var(--shadow-xl);
    border-color: var(--color-secondary-400);
  }

  .card-header {
    background: linear-gradient(135deg, var(--color-primary-50), var(--color-surface));
    padding: var(--space-4) var(--space-5);
    border-bottom: 1px solid var(--color-neutral-100);
  }

  .ayah-badge {
    display: inline-flex;
    align-items: center;
    gap: var(--space-2);
    background: var(--color-secondary-100);
    color: var(--color-secondary-700);
    padding: var(--space-1) var(--space-3);
    border-radius: var(--radius-md);
    font-weight: var(--font-semibold);
    font-size: var(--text-sm);
    border: 1px solid var(--color-secondary-200);
  }

  .card-body {
    padding: var(--space-5);
  }

  .card-title {
    font-size: var(--text-lg);
    font-weight: var(--font-semibold);
    color: var(--color-text-primary);
    line-height: var(--leading-snug);
    margin-bottom: var(--space-4);
  }

  .read-more {
    display: inline-flex;
    align-items: center;
    gap: var(--space-2);
    color: var(--color-primary-600);
    font-size: var(--text-sm);
    font-weight: var(--font-medium);
    transition: all var(--transition-base);
  }

  .entry-card:hover .read-more {
    color: var(--color-secondary-600);
    gap: var(--space-3);
  }

  /* Empty State */
  .empty-state {
    text-align: center;
    padding: var(--space-16) var(--space-8);
    background: var(--color-surface);
    border-radius: var(--radius-2xl);
    border: 2px dashed var(--color-neutral-300);
    max-width: 500px;
    margin: 0 auto var(--space-12);
  }

  .empty-icon {
    font-size: 4rem;
    margin-bottom: var(--space-4);
    opacity: 0.5;
  }

  .empty-state h3 {
    font-size: var(--text-xl);
    color: var(--color-text-primary);
    margin-bottom: var(--space-2);
  }

  .empty-state p {
    color: var(--color-text-secondary);
    margin-bottom: var(--space-6);
  }

  .btn-add {
    display: inline-flex;
    align-items: center;
    gap: var(--space-2);
    padding: var(--space-3) var(--space-6);
    background: linear-gradient(135deg, var(--color-secondary-500), var(--color-secondary-600));
    color: var(--color-primary-900);
    border-radius: var(--radius-full);
    text-decoration: none;
    font-weight: var(--font-semibold);
    transition: all var(--transition-base);
    box-shadow: 0 4px 14px 0 rgba(218, 165, 32, 0.39);
  }

  .btn-add:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px 0 rgba(218, 165, 32, 0.5);
  }

  /* Navigation */
  .surah-navigation {
    text-align: center;
    padding-top: var(--space-8);
    border-top: 1px solid var(--color-neutral-200);
  }

  .nav-button {
    display: inline-flex;
    align-items: center;
    gap: var(--space-2);
    color: var(--color-text-secondary);
    text-decoration: none;
    font-weight: var(--font-medium);
    transition: all var(--transition-base);
    padding: var(--space-3) var(--space-5);
    border-radius: var(--radius-lg);
  }

  .nav-button:hover {
    color: var(--color-primary-600);
    background: var(--color-primary-50);
  }

  /* Error State */
  .error-container {
    min-height: 60vh;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: var(--space-8);
  }

  .error-message {
    text-align: center;
    max-width: 500px;
  }

  .error-message h2 {
    font-size: var(--text-3xl);
    color: var(--color-text-primary);
    margin-bottom: var(--space-4);
  }

  .error-message p {
    color: var(--color-text-secondary);
    margin-bottom: var(--space-6);
  }

  .btn-primary {
    display: inline-block;
    padding: var(--space-3) var(--space-6);
    background: var(--color-primary-600);
    color: white;
    border-radius: var(--radius-lg);
    text-decoration: none;
    font-weight: var(--font-semibold);
    transition: all var(--transition-base);
  }

  .btn-primary:hover {
    background: var(--color-primary-700);
    transform: translateY(-2px);
  }

  /* ==================== ANIMATIONS ==================== */
  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(30px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* ==================== RESPONSIVE ==================== */
  @media (max-width: 768px) {
    .surah-hero {
      padding: var(--space-10) 0 var(--space-8);
    }

    .surah-title {
      font-size: var(--text-3xl);
    }

    .surah-title-arabic {
      font-size: var(--text-2xl);
    }

    .entries-grid {
      grid-template-columns: 1fr;
      gap: var(--space-4);
    }

    .empty-state {
      padding: var(--space-12) var(--space-6);
    }
  }

  /* ==================== DARK MODE ==================== */
  :global([data-theme="dark"]) .surah-hero {
    background: linear-gradient(
      135deg,
      hsl(218, 35%, 15%) 0%,
      hsl(218, 40%, 10%) 50%,
      hsl(218, 45%, 8%) 100%
    );
  }

  :global([data-theme="dark"]) .hero-bg-pattern {
    opacity: 0.15;
  }

  :global([data-theme="dark"]) .entry-card {
    background: var(--color-surface-variant);
    border-color: var(--color-neutral-700);
  }

  :global([data-theme="dark"]) .entry-card:hover {
    border-color: var(--color-secondary-500);
  }

  :global([data-theme="dark"]) .card-header {
    background: linear-gradient(135deg, var(--color-primary-100), var(--color-surface-variant));
    border-color: var(--color-neutral-700);
  }

  :global([data-theme="dark"]) .nav-button:hover {
    background: var(--color-primary-100);
  }
</style>
